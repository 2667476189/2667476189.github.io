---
title: 图表类型的页面懒加载
date: 2021-09-17 17:32:27
tags:
    - 懒加载
    - JavaScript
---

图表的懒加载
<!-- more -->

## MutationObserver的作用

检测dom的attr的变化，如果发生变化，就根据其变化状态决定是否加载

```js
/**
 * @function attributeChanged
 * @param {Object} records dom观察的回调，被修改的dom信息
 * @return {void}
 * @description 被修改属性后调用来进行加载
 */
attributeChanged(records) {
    let el, code
    records.forEach((record) => {
        // 如果code发生变化，则此时动态加载其对应的echarts图表
        if (record.attributeName === 'code') {
            el = record.target
            code = el.getAttribute('code')
            this.updateCharts(this.jjList[code], code)
        }
    })
}
/**
 * @function initMutationObserver
 * @return {void}
 * @description 初始化dom观察
 */
initMutationObserver() {
    const config = {
        attributes: true,
    }
    this.mo = new MutationObserver(this.attributeChanged)
    const els = document.querySelectorAll('.row')
    els.forEach((el) => {
        this.mo.observe(el, config)
    })
}
```

## IntersectionObserver的作用

浏览器用于异步检测某个元素相对于另一个元素的视口的可见性的观察，当检测到对应的echarts图表已经有一半滚入了外部容器的视口中，则触发修改其attr的变化

```js
/**
 * @function changeAttribute
 * @param {Object} els 交错观察的回调，交错状态到达阈值的元素
 * @return {void}
 * @description 修改其属性值
 */
changeAttribute(els) {
    let dom
    let shouldLoad
    els.forEach((el) => {
        dom = el.target
        shouldLoad =
            el.intersectionRatio > this.limit &&
            dom.hasAttribute('lazy-code')
        // 到了要展示的阈值,并且尚未进行过展示
        if (shouldLoad) {
            dom.setAttribute('code', dom.getAttribute('lazy-code'))
            dom.removeAttribute('lazy-code')
        }
    })
}
/**
 * @function initIntersectionObserver
 * @return {void}
 * @description 初始化交错观察
 */
initIntersectionObserver() {
    const config = {
        root: document.querySelector('#root'),
        threshold: [this.limit], // 若划过阈值点，再行加载
    }
    this.io = new IntersectionObserver(this.changeAttribute, config)
    const els = document.querySelectorAll('.row')
    els.forEach((el) => {
        this.io.observe(el)
    })
},
```

## 样例

{% raw %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/assd12138/cdnJS/lazyLoad/st.css">
<div id="app" v-cloak>
  <div class="wrap">
    <div v-for="(item,key) in jjList" :key="key" :lazy-code="key" class="row">
      <div class="title">{{item.name}}</div>
      <div class="card-dwjz card"></div>
      <div class="card-ljsyl card"></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.2.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/assd12138/cdnJS/lazyLoad/options.js"></script>
<script src="https://cdn.jsdelivr.net/gh/assd12138/cdnJS/lazyLoad/lazy.js"></script>
{% endraw %}